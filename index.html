<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grove Portal</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #111; color: #eee; }
    button { margin: 0.5rem 0; padding: 0.5rem 1rem; cursor: pointer; }
    textarea { width: 100%; height: 80px; margin-bottom: 0.5rem; }
    hr { margin: 2rem 0; border-color: #444; }
    #postSection { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>Welcome to Grove Portal</h1>

  <div>
    <button id="signUpBtn">Sign Up</button>
    <button id="signInBtn">Sign In</button>
  </div>

  <hr>

  <div id="postSection" style="display:none;">
    <h2>Create a Post</h2>
    <textarea id="postContent" placeholder="Write something..."></textarea><br>

    <label>
      <input type="checkbox" id="velmaraCheck">
      Velmara (restricted)
    </label><br>

    <button id="postBtn">Post</button>

    <h2>Feed</h2>
    <ul id="feed"></ul>
  </div>

  <script type="module">
    import { supabase } from './supabase.js';

    let currentUser = null;
    let currentUserRole = 'guest';

    async function loadFeed() {
      const { data: posts, error } = await supabase
        .from('posts')
        .select('id, content, created_at, user_id, access_level')
        .order('created_at', { ascending: false });

      const feedEl = document.getElementById('feed');
      feedEl.innerHTML = '';

      if (!posts) return;

      posts.forEach(post => {
        if (post.access_level === 'velmara' && !['member','admin'].includes(currentUserRole)) return;

        const li = document.createElement('li');
        li.textContent = `${post.content} (${new Date(post.created_at).toLocaleString()})`;
        feedEl.appendChild(li);
      });
    }

    document.getElementById('signUpBtn').onclick = async () => {
      const email = prompt("Email:");
      const password = prompt("Password:");
      const username = prompt("Username:");
      if (!email || !password || !username) return alert("All fields are required");

      const { data: user, error: signUpError } = await supabase.auth.signUp({ email, password });
      if (signUpError) return alert(signUpError.message);

      // Insert into profiles table
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .insert([{ id: user.user.id, username, role: 'guest' }]);

      if (profileError) return alert(profileError.message);

      alert("Sign-up successful! You can now log in.");
    };

    document.getElementById('signInBtn').onclick = async () => {
      const email = prompt("Email:");
      const password = prompt("Password:");
      if (!email || !password) return alert("Required");

      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert(error.message);

      currentUser = data.user;

      // Fetch user profile
      const { data: profile } = await supabase
        .from('profiles')
        .select('role')
        .eq('id', currentUser.id)
        .single();

      currentUserRole = profile?.role || 'guest';
      document.getElementById('postSection').style.display = 'block';
      loadFeed();
    };

    document.getElementById('postBtn').onclick = async () => {
      const content = document.getElementById('postContent').value;
      if (!content) return alert("Cannot post empty content");

      const access_level = document.getElementById('velmaraCheck').checked ? 'velmara' : 'public';

      const { data, error } = await supabase
        .from('posts')
        .insert([{ content, user_id: currentUser.id, access_level }]);

      if (error) return alert(error.message);

      document.getElementById('postContent').value = '';
      document.getElementById('velmaraCheck').checked = false;
      loadFeed();
    };
  </script>
</body>
</html>
